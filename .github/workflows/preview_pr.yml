name: 3. PR ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
# Pull RequestãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸã¨ãã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.html'
      - '**.css'
      - '**.js'

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # gh-pagesãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã®ãŸã‚
      pull-requests: write  # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã®ãŸã‚

    steps:
      - name: â¬‡ï¸ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: ğŸ“¦ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æº–å‚™
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          mkdir -p preview/pr-${PR_NUMBER}

          # HTMLã¨CSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
          find . -maxdepth 1 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) -exec cp {} preview/pr-${PR_NUMBER}/ \;

          echo "âœ… PR #${PR_NUMBER} ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’æº–å‚™ã—ã¾ã—ãŸ"
          ls -la preview/pr-${PR_NUMBER}/

      - name: ğŸš€ GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆgh-pagesãƒ–ãƒ©ãƒ³ãƒï¼‰
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview
          destination_dir: preview
          keep_files: true  # ä»–ã®PRã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¿æŒ
          commit_message: "Deploy preview for PR #${{ github.event.pull_request.number }}"

      - name: ğŸ’¬ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repoName = context.repo.repo;
            const owner = context.repo.owner;
            const previewUrl = `https://${owner}.github.io/${repoName}/preview/pr-${prNumber}/index.html`;

            const comment = `## ğŸ‰ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒæº–å‚™ã§ãã¾ã—ãŸï¼

            **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL**: [${previewUrl}](${previewUrl})

            ã“ã®PRã®å¤‰æ›´å†…å®¹ã‚’ä¸Šè¨˜URLã§ç¢ºèªã§ãã¾ã™ã€‚

            ### ğŸ“„ ãƒšãƒ¼ã‚¸ä¸€è¦§
            - [ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸](${previewUrl})
            - [Aboutãƒšãƒ¼ã‚¸](https://${owner}.github.io/${repoName}/preview/pr-${prNumber}/about.html)

            ---
            ğŸ¤– ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ`;

            // æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: owner,
              repo: repoName,
              issue_number: prNumber
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒæº–å‚™ã§ãã¾ã—ãŸ')
            );

            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: owner,
                repo: repoName,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: owner,
                repo: repoName,
                issue_number: prNumber,
                body: comment
              });
            }
