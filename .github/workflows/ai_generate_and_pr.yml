name: 1. AIã‚³ãƒ¼ãƒ‰ç”Ÿæˆã¨PRä½œæˆ
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒActionsã‚¿ãƒ–ã‹ã‚‰æ‰‹å‹•ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ [4]
on:
  workflow_dispatch:
    inputs:
      request_description:
        description: 'AIã«ä½œæˆã—ã¦ã»ã—ã„ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ä¾é ¼å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
        required: true
        type: string

jobs:
  generate_and_pr:
    runs-on: ubuntu-latest
    # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«å¿…è¦ãªæ¨©é™ã‚’æ˜ç¤ºçš„ã«è¨­å®šï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰
    permissions:
      contents: write       # ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥ã®ãŸã‚ [5]
      pull-requests: write  # PRä½œæˆã®ãŸã‚ [5]
      issues: write         # ã‚¤ã‚·ãƒ¥ãƒ¼ä½œæˆã®ãŸã‚ [5]
    
    steps:
      - name: â¬‡ï¸ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: âš™ï¸ å¿…è¦ãªPythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install google-genai pydantic
        
      - name: ğŸ› ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚¤ã‚·ãƒ¥ãƒ¼ã®è‡ªå‹•ä½œæˆ
        # GitHub CLI (gh) ã‚’ä½¿ç”¨ã—ã¦ã€ä¾é ¼å†…å®¹ã‚’åŸºã«ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã€ã‚¤ã‚·ãƒ¥ãƒ¼ç•ªå·ã‚’å¤‰æ•°ã«ä¿å­˜ [6]
        run: |
          # ä¾é ¼å†…å®¹ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã€å‡ºåŠ›ã‹ã‚‰ã‚¤ã‚·ãƒ¥ãƒ¼ç•ªå·ã‚’æŠ½å‡º
          issue_output=$(gh issue create --title "AIç”Ÿæˆä¾é ¼: ${{ github.event.inputs.request_description }}" --body "ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾é ¼: ${{ github.event.inputs.request_description }}")
          issue_num=$(echo $issue_output | awk -F'/' '{print $NF}')

          # ã‚¤ã‚·ãƒ¥ãƒ¼ç•ªå·ã¨ãƒ–ãƒ©ãƒ³ãƒåã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ä¸€æ„æ€§ã‚’ç¢ºä¿ï¼‰
          timestamp=$(date +%Y%m%d-%H%M%S)
          echo "ISSUE_NUMBER=$issue_num" >> $GITHUB_ENV
          echo "BRANCH_NAME=feature/ai-website-${issue_num}-${timestamp}" >> $GITHUB_ENV
          echo "âœ… ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚¤ã‚·ãƒ¥ãƒ¼ #${issue_num} ã‚’ä½œæˆã—ã¾ã—ãŸã€‚"
        env:
          # GitHub CLIèªè¨¼ã®ãŸã‚ã«å¿…é ˆ
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¤– AIã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’å®Ÿè¡Œã—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        # GEMINI_API_KEYã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æ³¨å…¥ã—ã€Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ã‚‹ [7, 3]
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python generate_website.py "${{ github.event.inputs.request_description }}"

      - name: ğŸ”„ Pull Requestã‚’è‡ªå‹•ä½œæˆï¼ˆã‚³ãƒŸãƒƒãƒˆã¨ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‚’å«ã‚€ï¼‰
        # Peter Evansæ°ã®Actionã¯ã€å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«ã‚³ãƒŸãƒƒãƒˆã—ã€æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã€PRã‚’ä½œæˆã™ã‚‹ [5, 8]
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(ai): generated website for issue #${{ env.ISSUE_NUMBER }}"
          title: "AIç”Ÿæˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ: Issue #${{ env.ISSUE_NUMBER }}"
          branch: ${{ env.BRANCH_NAME }}
          base: main
          body: |
            ã“ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã¯ã€Issue #${{ env.ISSUE_NUMBER }} ã®ä¾é ¼ã«åŸºã¥ãã€Gemini APIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
            ã‚³ãƒ¼ãƒ‰ã®å“è³ªã¨ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

            ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã€Issue #${{ env.ISSUE_NUMBER }} ã¯è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚

            Closes #${{ env.ISSUE_NUMBER }} # PRã¨ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ç´ä»˜ã‘ã€ãƒãƒ¼ã‚¸æ™‚ã«ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º

      - name: ğŸ“¦ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æº–å‚™
        if: steps.create-pr.outputs.pull-request-number != ''
        run: |
          mkdir -p preview/pr-${{ steps.create-pr.outputs.pull-request-number }}

          # HTMLã¨CSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
          find . -maxdepth 1 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) -exec cp {} preview/pr-${{ steps.create-pr.outputs.pull-request-number }}/ \;

          echo "âœ… PR #${{ steps.create-pr.outputs.pull-request-number }} ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’æº–å‚™ã—ã¾ã—ãŸ"
          ls -la preview/pr-${{ steps.create-pr.outputs.pull-request-number }}/

      - name: ğŸš€ GitHub Pagesã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview
          destination_dir: preview
          keep_files: true
          commit_message: "Deploy preview for PR #${{ steps.create-pr.outputs.pull-request-number }}"

      - name: ğŸ’¬ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};
            const repoName = context.repo.repo;
            const owner = context.repo.owner;
            const previewUrl = `https://${owner}.github.io/${repoName}/preview/pr-${prNumber}/index.html`;

            const comment = `## ğŸ‰ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒæº–å‚™ã§ãã¾ã—ãŸï¼

            **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL**: [${previewUrl}](${previewUrl})

            ã“ã®PRã®å¤‰æ›´å†…å®¹ã‚’ä¸Šè¨˜URLã§ç¢ºèªã§ãã¾ã™ã€‚

            ### ğŸ“„ ãƒšãƒ¼ã‚¸ä¸€è¦§
            - [ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸](${previewUrl})
            - [Aboutãƒšãƒ¼ã‚¸](https://${owner}.github.io/${repoName}/preview/pr-${prNumber}/about.html)

            ---
            ğŸ¤– ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ`;

            await github.rest.issues.createComment({
              owner: owner,
              repo: repoName,
              issue_number: prNumber,
              body: comment
            });